# Differential Expression Analysis {#diff-exp}

<iframe width="560" height="2" src="" frameborder="0" allowfullscreen></iframe>

//TODO insert video of performing differential expression analysis using Omics Central here

```{r, echo = FALSE, warning = FALSE, message = FALSE}
knitr::opts_chunk$set(cache = FALSE, echo = FALSE, warning = FALSE, message = FALSE, tidy = TRUE)

# setup
library(limma);  ## bioconductor
library(csSAM);
library(ggrepel);
source("helper_functions.R")

# load datasets
load(here::here("data", "biomonitoringBloodBiomarkersDatasets.Rdata"))
X.trainList$holter <- log2(X.trainList$holter)

## select dataset
X <- t(X.trainList$proteins)
avg <- rowMeans(X)
fc <- rowMeans(X[, hosp_3months == "Yes"]) - rowMeans(X[, hosp_3months == "No"])
```

## Methods

### Ordinary Least Squares

```{r}
ols_pvals <- apply(X, 1, function(i){
  fit <- lm(i~hosp_3months)
  coef(summary(fit))[2, "Pr(>|t|)"]
})
ols_fdr <- p.adjust(ols_pvals, "BH")
ols_fdr <- ols_fdr[order(ols_fdr)]
```

### LInear Models for MicroArrays and RNA-Seq

#### LIMMA

```{r}
design <- model.matrix(~hosp_3months)
fit <- eBayes(lmFit(X, design, method = "ls"))
top_limma <- topTable(fit, coef = "hosp_3monthsYes", n = nrow(fit), adjust.method = "BH")

limma_pvals <- top_limma$P.Value
limma_fdr <- top_limma$adj.P.Val
limma_fdr <- limma_fdr[order(limma_fdr)]
```

#### Robust LIMMA

```{r}
design <- model.matrix(~hosp_3months)
fit <- eBayes(lmFit(X, design, method = "robust"))
top_rlimma <- topTable(fit, coef = "hosp_3monthsYes", n = nrow(fit), adjust.method = "BH")

rlimma_pvals <- top_rlimma$P.Value
rlimma_fdr <- top_rlimma$adj.P.Val
rlimma_fdr <- rlimma_fdr[order(rlimma_fdr)]
```

#### LIMMA VOOM (adjusts for heteroscdasticity)

```{r}
v <- voom(2^X, design, plot=TRUE)
fit <- lmFit(v, design)
fit <- eBayes(fit)
top_vlimma <- topTable(fit, coef = "hosp_3monthsYes", n = nrow(fit), adjust.method = "BH")

vlimma_pvals <- top_vlimma$P.Value
vlimma_fdr <- top_vlimma$adj.P.Val
vlimma_fdr <- vlimma_fdr[order(vlimma_fdr)]
```

### Significance Analysis for Microarrays (SAM)

### cell-specific Analysis for Microarrays (csSAM)

```{r}
# from https://cran.r-project.org/web/packages/csSAM/csSAM.pdf
G <- X.trainList$proteins
cc <- X.trainList$cells
all(rownames(G) == rownames(cc))
## combine all lymphocytes into one since then number of cells is greater than the number of samples in one of the groups, and remove Eosinophils because most values are zeros
lyms <- c("B cells naive", "Plasma cells", "T cells CD8", "T cells CD4 naive", "T cells CD4 memory resting", "T cells CD4 memory activated", "T cells regulatory (Tregs)", "NK cells resting")
mono <- c("Monocytes", "Macrophages M2")
cc <- cbind(cc[, setdiff(colnames(cc), "Eosinophils")], "Lymphocytes"= rowSums(cc[, lyms, drop = FALSE]), "Monocytes"= rowSums(cc[, mono, drop = FALSE]))
cc <- cc[, setdiff(colnames(cc), c(lyms, mono))]


cellID <- colnames(cc)
numcell <- ncol(cc)
numgene <- ncol(G)
y <- hosp_3months
n <- table(y)

deconv <- list()
# run analysis
for (curset in levels(y)){
  deconv[[curset]]= csfit(cc[y==curset,], G[y==curset,])
}
rhat <- array(dim = c(numcell,numgene))
rhat[, ] <- csSAM(deconv[[1]]$ghat, deconv[[1]]$se,
n[1], deconv[[2]]$ghat, deconv[[2]]$se, n[2],
standardize=TRUE, medianCenter=TRUE, nonNeg=TRUE)
tt.sam <- runSAM2(G, y)

alternative <- c('two.sided', 'greater', 'less')
falseDiscovR <- lapply(alternative, function(i){
  falseDiscovR <- fdrCsSAM2(G,cc,y,n,numcell,numgene, rhat, 
    nperms = 200,standardize=TRUE,alternative=i, medianCenter=TRUE, nonNeg=TRUE)
  sigGene <- findSigGene(G, cc, y, rhat, falseDiscovR)
  colnames(sigGene) <- colnames(G)
  rownames(sigGene) <- colnames(cc)
  sigGene
})
names(falseDiscovR) <- alternative
# falseDiscovRSAM <- fdrSAM2(G, y, nperms=200, tt.sam , alternative = alternative)
# sam_fdr <- falseDiscovRSAM$sigGene.sam
# sam_fdr[sam_fdr > 1] <- 1
# sam_fdr <- sam_fdr[order(sam_fdr)]

```

## Visualizations

### Number of differentially expressed genes

```{r}
p <- ncol(G)
data.frame(n_sig = rep(1:p, 4),
           fdr = c(ols_fdr, limma_fdr, rlimma_fdr, vlimma_fdr),
           method = rep(c("OLS", "LIMMA", "rLIMMA", "vLIMMA"), each = p)) %>% 
  ggplot(aes(x = n_sig, y = fdr, color = method, group = method)) +
  geom_point() +
  geom_line() +
  scale_x_log10() +
  theme_classic() +
  ylab("False Discovery rate (FDR)") + 
  xlab("Number of significant genes")

```

### P-value histograms

```{r}
data.frame(pvals = c(ols_pvals, limma_pvals, rlimma_pvals, vlimma_pvals),
           method = rep(c("OLS", "LIMMA", "rLIMMA", "vLIMMA"), each = p)) %>% 
  ggplot(aes(x = pvals)) +
  geom_histogram(bins = 20) +
  theme_classic() +
  facet_wrap(~method) +
  geom_hline(yintercept = 5, linetype = "dashed", color = "gray") +
  xlab("p-values") + 
  ylab("Frequency")

```

### MA plot

```{r}
ma <- data.frame(fc = fc,
           pvals = -log10(ols_pvals[names(fc)]),
           sym = names(fc),
  fdr = ols_fdr[names(fc)])
maSubset <- ma %>% filter(fdr < 0.1)
ggplot(ma, aes(x = fc, y = pvals)) +
  geom_point() +
  geom_text_repel(data=maSubset, aes(x = fc, y = pvals, label = sym)) + 
  theme_classic() +
  geom_vline(xintercept = 0, linetype = "dashed", color = "gray") +
  xlab("Fold-change") + 
  ylab(expression('-log'[10]~'(p-value)'))
  
```

### csSAM

```{r}
ccsam_results <- data.frame(All = as.numeric(falseDiscovR$two.sided),
  Up = as.numeric(falseDiscovR$greater),
  Down = as.numeric(falseDiscovR$less))
ccsam_results$Feature <- rep(colnames(G), each = ncol(cc))
ccsam_results$Cell <- colnames(cc)

ccsam_results %>% 
  gather(Comparison, fdr, -c(Cell, Feature)) %>% 
  group_by(Comparison, Cell) %>% 
  arrange(fdr) %>% 
  mutate(nsig = dplyr::row_number()) %>% 
  ggplot(aes(x = nsig, y = fdr)) +
  geom_point() +
  scale_x_log10() +
  geom_line() +
  facet_grid(Comparison ~ Cell) +
  xlab("Number of significant genes") +
  ylab("False Discovery Rate") +
  theme_bw() +
  ylim(c(0,1))



```


```{r}
## Shape data for webapp
library(jsonlite)

fdr_to_nsig = function(fdr, cutoff = c(0.01, 0.05, 0.1, 0.2, 0.3, 0.4, 0.5, 1)){
  sapply(cutoff, function(i){
    sum(fdr<=i)
  })
}

sig_cutoff = function(pvals, fdrs){
  sigCuts <- lapply(c(0.01, 0.05, 0.1, 0.2), function(i){
    -log10(max(pvals[fdrs < i]))
  })
  names(sigCuts) <- c(0.01, 0.05, 0.1, 0.2)
  sigCuts
}


br = seq(0,1,by=0.1)
ranges = paste(head(br,-1), br[-1], sep=" - ")
dexp <- lapply(names(X.trainList), function(i){
  cat(i, '\n')
  X <- t(X.trainList[[i]])
  fc <- rowMeans(X[,hosp_3months == "Yes"])-rowMeans(X[,hosp_3months == "No"])
  ## OLS
  ols_pvals <- apply(X, 1, function(i){
    fit <- lm(i~hosp_3months)
    coef(summary(fit))[2, "Pr(>|t|)"]
  })
  # pval bins
  freq   = hist(ols_pvals, breaks=br, include.lowest=TRUE, plot=FALSE)
  ols_pvalBins <- freq$counts
  # fdr
  ols_fdr <- p.adjust(ols_pvals, "BH")
  ols_fdr_ord <- ols_fdr[order(ols_fdr)]
  
  ## limma
  design <- model.matrix(~hosp_3months)
  fit <- eBayes(lmFit(X, design, method = "ls"))
  top_limma <- topTable(fit, coef = "hosp_3monthsYes", n = nrow(fit), adjust.method = "BH")
  limma_pvals <- top_limma$P.Value
  # pval bins
  freq   = hist(limma_pvals, breaks=br, include.lowest=TRUE, plot=FALSE)
  limma_pvalBins <- freq$counts
  # fdr
  limma_fdr <- top_limma$adj.P.Val
  limma_fdr_ord <- limma_fdr[order(limma_fdr)]
  
  ## Robust limma
  rfit <- eBayes(lmFit(X, design, method = "robust", maxit=50))
  top_rlimma <- topTable(rfit, coef = "hosp_3monthsYes", n = nrow(rfit), adjust.method = "BH")
  rlimma_pvals <- top_rlimma$P.Value
  # pval bins
  freq   = hist(rlimma_pvals, breaks=br, include.lowest=TRUE, plot=FALSE)
  rlimma_pvalBins <- freq$counts
  ## Robust limma
  rlimma_fdr <- top_rlimma$adj.P.Val
  rlimma_fdr_ord <- rlimma_fdr[order(rlimma_fdr)]
  
  ## limma voom
  v <- voom(2^X, design, plot=TRUE)
  vfit <- eBayes(lmFit(v, design))
  top_vlimma <- topTable(vfit, coef = "hosp_3monthsYes", n = nrow(vfit), adjust.method = "BH")
  vlimma_pvals <- top_vlimma$P.Value
  # pval bins
  freq   = hist(vlimma_pvals, breaks=br, include.lowest=TRUE, plot=FALSE)
  vlimma_pvalBins <- freq$counts
  ## Robust limma
  vlimma_fdr <- top_vlimma$adj.P.Val
  vlimma_fdr_ord <- vlimma_fdr[order(vlimma_fdr)]
  
  list(pvalBins = list(ols=ols_pvalBins, 
                       limma=limma_pvalBins, 
                       rlimma=rlimma_pvalBins, 
                       vlimma=vlimma_pvalBins),
    h0Line = rep(nrow(X)/10, 10),
    fdrs = list(ols=fdr_to_nsig(ols_fdr_ord), 
                limma=fdr_to_nsig(limma_fdr_ord), 
                rlimma=fdr_to_nsig(rlimma_fdr_ord), 
                vlimma=fdr_to_nsig(vlimma_fdr_ord)),
    sig = list(ols=-log10(ols_pvals),
               limma=-log10(limma_pvals),
               rlimma=-log10(rlimma_pvals),
               vlimma=-log10(vlimma_pvals)),
    sig_fdrCutoffs = list(ols=sig_cutoff(ols_pvals, ols_fdr),
                          limma=sig_cutoff(limma_pvals, limma_fdr),
                          rlimma=sig_cutoff(rlimma_pvals, rlimma_fdr),
                          vlimma=sig_cutoff(vlimma_pvals, vlimma_fdr)),
    fc = fc,
    featureNames = names(fc))
})
names(dexp) <- names(X.trainList)

# histograms
nsig <- lapply(names(X.trainList), function(i){
  dexp[[i]]$fdrs
})
pvalBins <- lapply(names(X.trainList), function(i){
  dexp[[i]]$pvalBins
})
h0Line <- lapply(names(X.trainList), function(i){
  dexp[[i]]$h0Line
})
sig <- lapply(names(X.trainList), function(i){
  dexp[[i]]$sig
})
sig_fdrCutoffs <- lapply(names(X.trainList), function(i){
  dexp[[i]]$sig_fdrCutoffs
})
fc <- lapply(names(X.trainList), function(i){
  dexp[[i]]$fc
})
featureNames <- lapply(names(X.trainList), function(i){
  dexp[[i]]$featureNames
})

# csSAM
cssamResults <- lapply(names(X.trainList), function(i){
  cat(i, '\n')
  X <- X.trainList[[i]]
  
  cellID <- colnames(cc)
  numcell <- ncol(cc)
  numgene <- ncol(X)
  y <- hosp_3months
  n <- table(y)
  
  deconv <- list()
  # run analysis
  for (curset in levels(y)){
    deconv[[curset]]= csfit(cc[y==curset,], X[y==curset,])
  }
  rhat <- array(dim = c(numcell,numgene))
  rhat[, ] <- csSAM(deconv[[1]]$ghat, deconv[[1]]$se, 
              n[1], deconv[[2]]$ghat, deconv[[2]]$se, n[2],
              standardize=TRUE, medianCenter=TRUE, nonNeg=TRUE)
  tt.sam <- runSAM2(G, y)
  alternative <- c('two.sided', 'greater', 'less')
  falseDiscovR <- lapply(alternative, function(i){
    falseDiscovR <- fdrCsSAM2(X,cc,y,n,numcell,numgene, rhat, 
      nperms = 200,standardize=TRUE,alternative=i, medianCenter=TRUE, nonNeg=TRUE)
    sigGene <- findSigGene(X, cc, y, rhat, falseDiscovR)
    colnames(sigGene) <- colnames(X)
    rownames(sigGene) <- colnames(cc)
    as.list(as.data.frame(apply(sigGene, 1, fdr_to_nsig)))
  })
  names(falseDiscovR) <- alternative
  falseDiscovR
})

## label lists
names(nsig) <-names(pvalBins) <- names(h0Line) <- names(sig) <- names(sig_fdrCutoffs) <- names(fc) <- names(featureNames) <- names(cssamResults) <- names(dexp)

write(toJSON(list(dexp = list(datasets = names(X.trainList),
  data = lapply(X.trainList, function(i) as.list(as.data.frame(i))),
  response = hosp_3months,
  responseLabel = unbox("hospitalization status"),
  fdrs = list(fdr=c(0.01, 0.05, 0.1, 0.2, 0.3, 0.4, 0.5, 1), nsig = nsig),
  pvalHist = list(bins = c("0-0.1", "0.1-0.2", "0.3-0.4", "0.4-0.5", "0.5-0.6", "0.6-0.7", "0.7-0.8", "0.8-0.9", "0.9-1"), pvalBins=pvalBins, h0Line=h0Line),
  volcanoPlot = list(sig=sig, fc=fc, sig_fdrCutoffs=sig_fdrCutoffs),
  featureNames = featureNames,
  cssamResults = list(fdr=c(0.01, 0.05, 0.1, 0.2, 0.3, 0.4, 0.5, 1), nsig=cssamResults)))), "json/dexp_sampleData.json")

```

